<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trang chủ | MEDIC-PRO</title>

    <th:block th:replace="/homepage/fragment/head_css"/>
</head>

<body>
<div class="container-fluid">
    <th:block th:replace="/homepage/fragment/header"/>


    <div class="content">

        <div class="style_wrapper_content__2nPtC">
            <div class="style_bg_breakcum__2BT1J">
                <div data-test="container" class="container">
                    <div data-test="row" class="row">
                        <div data-test="col" class="col-12">
                            <div class="style_wrap_mdbreadcrumb__1e17- style_head__1hfhC">
                                <nav data-test="breadcrumb">
                                    <ol class="breadcrumb">
                                        <li data-test="breadcrumb-item" class="breadcrumb-item"><a href="/static">Trang
                                            chủ</a></li>
                                        <li data-test="breadcrumb-item" class="breadcrumb-item">Tạo hồ sơ bệnh nhân
                                        </li>
                                    </ol>
                                </nav>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div>
                <div data-test="container" class="container">
                    <div data-test="row" class="row">
                        <div data-test="col" class="col-md-12">
                            <div>
                                <h2 class="style_title_component__3jzrX style_title_line__3AhYV style_title_header_mobile__23s4W">
                                    <span>Tạo mới hồ sơ</span>
                                </h2>

                                <div data-test="tabContent" class="tab-content">
                                    <div data-test="tab-pane" role="tabpanel" class="tab-pane active">
                                        <div data-test="animation" class="animated fadeIn"
                                             style="animation-iteration-count: 1; visibility: visible; animation-name: fadeIn;">
                                            <form class="style_form_medpro__nfoJ1 style_form_update__2XmGr" method="post" id="frmCreate">
                                                <div>
                                                    <h2 class="style_title_component__3jzrX style_title_headline__1RPh4">
                                                        <span>Nhập thông tin bệnh nhân</span>
                                                    </h2>
                                                    <div data-test="alert" class="alert alert-primary" role="alert">
                                                        Vui lòng cung cấp thông tin chính xác để được phục vụ tốt
                                                        nhất. Trong trường hợp cung cấp sai thông tin bệnh nhân
                                                        &amp; điện thoại, việc xác nhận cuộc hẹn sẽ không hiệu lực
                                                        trước khi đặt khám.
                                                    </div>
                                                    <div class="style_info_required__2nJlo">
                                                        <span class="style_alertSpan__2UfTW" style="margin-bottom: 15px;">(*)
                                                                Thông tin bắt buộc nhập
                                                        </span>
                                                    </div>

                                                    <div class="style_wapper_form_group__2xD4H">
                                                        <div class="style_form_group__3EAEk">
                                                            <label for="fullNameCre">Họ và tên (có dấu)<sup>*</sup>
                                                            </label>
                                                            <input id="fullNameCre" name="fullNameCre" type="text" class="form-control text-uppercase" placeholder="Ví dụ: Nguyễn Văn Bảo" maxlength="28" value="">
                                                            <span class="style_alertSpan__2UfTW"></span>
                                                        </div>
                                                        <div class="style_form_group__3EAEk">
                                                            <label for="dayCre">Ngày tháng năm sinh<sup>*</sup></label>
                                                            <div class="style_form_group_select__19IYg">
                                                                <select id="dayCre" class="browser-default custom-select">
                                                                    <option value="0">Ngày</option>
                                                                </select>

                                                                <select id="monthCre" class="browser-default custom-select">
                                                                    <option value="0">Tháng</option>
                                                                </select>

                                                                <select id="yearCre" class="browser-default custom-select">
                                                                    <option value="0">Năm</option>
                                                                </select>
                                                            </div>
                                                            <span class="style_alertSpan__2UfTW"></span>
                                                            <span class="style_alertSpan__2UfTW"></span>
                                                            <span class="style_alertSpan__2UfTW"></span>
                                                        </div>
                                                        <div class="style_form_group__3EAEk">
                                                            <label for="phoneCre">Số điện thoại<sup>*</sup></label>
                                                            <input type="text" id="phoneCre" name="phoneCre" class="form-control" placeholder="Nhập số điện thoại" value="">
                                                            <span class="style_alertSpan__2UfTW"></span>
                                                        </div>
                                                        <div class="style_form_group__3EAEk style_form_select__2iBjy">
                                                            <label for="genderCre">Giới tính<sup>*</sup></label>
                                                            <select id="genderCre" class="browser-default custom-select">
                                                                <option value="0">Chọn giới tính</option>
                                                                <option value="MALE">Nam</option>
                                                                <option value="FEMALE">Nữ</option>
                                                            </select>
                                                            <span class="style_alertSpan__2UfTW"></span>
                                                        </div>
                                                        <div class="style_form_group__3EAEk style_form_select__2iBjy">
                                                            <label for="jobCre">Nghề nghiệp <sup>*</sup></label>
                                                            <select id="jobCre" class="browser-default custom-select">
                                                                <option value="0">Chọn nghề nghiệp</option>
                                                            </select>
                                                            <span class="style_alertSpan__2UfTW"></span>
                                                        </div>
                                                        <div class="style_form_group__3EAEk">
                                                            <label for="identityCre">Số CMND/Passport<sup></sup></label>
                                                            <input type="text" id="identityCre" name="identityCre" class="form-control" placeholder="Nhập số CMND" value="">
                                                            <span class="style_alertSpan__2UfTW"></span>
                                                        </div>
                                                        <div class="style_form_group__3EAEk">
                                                            <label for="emailCre">Địa chỉ Email<sup></sup></label>
                                                            <input type="text" id="emailCre" name="emailCre" class="form-control"
                                                                   placeholder="Nhập địa chỉ email để nhận phiếu khám"
                                                                   value="">
                                                            <span class="style_alertSpan__2UfTW"></span>
                                                        </div>
                                                        <div class="style_form_group__3EAEk style_form_select__2iBjy">
                                                            <label for="ethnicCre">Dân tộc</label>
                                                            <select id="ethnicCre" class="browser-default custom-select">
                                                            </select>
                                                        </div>
                                                        <div class="style_form_group__3EAEk style_form_select__2iBjy">
                                                            <label for="provinceCre">Tỉnh / Thành<sup>*</sup></label>
                                                            <select id="provinceCre" class="browser-default custom-select">
                                                                <option value="0">Chọn tỉnh thành</option>
                                                            </select>
                                                            <span class="style_alertSpan__2UfTW"></span>
                                                        </div>
                                                        <div class="style_form_group__3EAEk style_form_select__2iBjy">
                                                            <label for="districtCre"> Quận / Huyện<sup>*</sup></label>
                                                            <select id="districtCre" class="browser-default custom-select">
                                                                <option value="0">Chọn quận huyện</option>
                                                            </select>
                                                            <span class="style_alertSpan__2UfTW"></span>
                                                        </div>
                                                        <div class="style_form_group__3EAEk style_form_select__2iBjy">
                                                            <label for="wardCre">Phường / Xã<sup>*</sup></label>
                                                            <select id="wardCre" class="browser-default custom-select">
                                                                <option value="0">Chọn phường xã</option>
                                                            </select>
                                                            <span class="style_alertSpan__2UfTW"></span>
                                                        </div>
                                                        <div class="style_form_group__3EAEk">
                                                            <label for="addressCre">Địa chỉ<sup>*</sup></label>
                                                            <input type="text" id="addressCre" name="addressCre" class="form-control"
                                                                   placeholder="Nhập địa chỉ" maxlength="100" value="">
                                                            <span class="style_alertSpan__2UfTW"></span>
                                                        </div>
                                                        <div class="style_form_group__3EAEk style_action_form__1hR3C">
                                                            <button data-test="button" type="button" id="btnClear"
                                                                    class="btn-flat btn Ripple-parent style_button__bKNrt style_reset__1qJB7">
                                                                <i class="fas fa-eraser"></i>
                                                                <div>Nhập lại</div>
                                                                <div data-test="waves" class="Ripple Ripple-outline " style="top: 0px; left: 0px; width: 0px; height: 0px;">
                                                                </div>
                                                            </button>
                                                            <button data-test="button" type="button" id="btnCreate"
                                                                    class="btn-flat btn Ripple-parent style_button__bKNrt style_create_patient_form__1321O">
                                                                <i class="fas fa-user-plus"></i>
                                                                <div>Tạo mới</div>
                                                                <div data-test="waves"
                                                                     class="Ripple Ripple-outline "
                                                                     style="top: 0px; left: 0px; width: 0px; height: 0px;">
                                                                </div>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </form>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- -----------------------Footer----------------------- -->

    <th:block th:replace="/homepage/fragment/footer"/>
</div>

<th:block th:replace="/homepage/fragment/footer_js"/>

<script>
    const page = {
        url: {
            getAllCustomers: App.API_CUSTOMER,
            getCustomerById: App.API_CUSTOMER,
            getAllProvince: App.API_LOCATION_REGION + '/',
            getAllDistricts: App.API_LOCATION_REGION + '/district',
            getAllWard: App.API_LOCATION_REGION + '/ward',
            getAllJob: App.API_JOB,
            getAllEthnic: App.API_ETHNIC,
            createCustomer: App.API_CUSTOMER,
        },
        elements: {},
        loadData: {},
        commands: {},
        initializeControlEvent: {}
    }


    page.elements.frmCreate = $('#frmCreate');
    page.elements.fullNameCre = $('#fullNameCre');
    page.elements.emailCre = $('#emailCre');
    page.elements.genderCre = $('#genderCre');
    page.elements.phoneCre = $('#phoneCre');
    page.elements.identityCre = $('#identityCre');
    page.elements.dayCre = $('#dayCre')
    page.elements.monthCre = $('#monthCre')
    page.elements.yearCre = $('#yearCre')
    page.elements.dobCre = $('#dobCre');
    page.elements.jobCre = $('#jobCre');
    page.elements.ethnicCre = $('#ethnicCre');
    page.elements.provinceCre = $('#provinceCre');
    page.elements.districtCre = $('#districtCre');
    page.elements.wardCre = $('#wardCre');
    page.elements.addressCre = $('#addressCre');
    page.elements.btnCreate = $('#btnCreate');
    page.elements.btnClear = $('#btnClear');

    let customerId = 0;
    let customer;
    let locationRegion = new LocationRegion();

    const userId = [[${userId}]];
    console.log(userId);

    page.commands.getAllYear = () => {
        for( let i = 2023; i >= 1900; i-- ){
            const str = `<option value="${i}">${i}</option>`;
            page.elements.yearCre.append(str)
        }
    }

    page.commands.getAllMonth = () => {
        for( let i = 1; i <= 12; i++ ){
            const str = `<option value="${i}">${i}</option>`;
            page.elements.monthCre.append(str)
        }
    }

    page.commands.getAllDay = () => {
        for( let i = 1; i <= 31; i++ ){
            const str = `<option value="${i}">${i}</option>`;
            page.elements.dayCre.append(str)
        }
    }

    page.commands.getAllJob = () => {
        return $.ajax({
            type: 'GET',
            url: page.url.getAllJob
        })
            .done((data) => {
                const jobs = data;
                page.elements.jobCre.empty();
                $.each(jobs, (index, item) => {
                    const str = `<option value="${item.id}">${item.name}</option>`;
                    page.elements.jobCre.append(str);
                });
            })
    }

    page.commands.getAllEthnic = () => {
        return $.ajax({
            type: 'GET',
            url: page.url.getAllEthnic
        })
            .done((data) => {
                const ethnics = data;
                page.elements.ethnicCre.empty();
                $.each(ethnics, (index, item) => {
                    const str = `<option value="${item.id}">${item.name}</option>`;
                    page.elements.ethnicCre.append(str);
                });
            })
    }

    page.commands.getAllProvince = () => {
        return $.ajax({
            type: 'GET',
            url: page.url.getAllProvince
        })
            .done((data) => {
                const provinces = data.results;
                page.elements.provinceCre.empty();
                $.each(provinces, (index, item) => {
                    const str = `<option value="${item.province_id}">${item.province_name}</option>`;
                    page.elements.provinceCre.append(str);
                });
            })
    }
    page.commands.getAllDistricts = (provinceId, elem) => {
        return $.ajax({
            type: 'GET',
            url: page.url.getAllDistricts + '/' + provinceId
        })
            .done((data) => {
                const districts = data.results;

                elem.empty();
                $.each(districts, (index, item) => {
                    const str = `<option value="${item.district_id}">${item.district_name}</option>`;

                    elem.append(str);
                });
            })
    }

    page.commands.getAllWards = (districtId, elem) => {
        $.ajax({
            type: 'GET',
            url: page.url.getAllWard + '/' + districtId
        })
            .done((data) => {
                const wards = data.results;
                elem.empty();
                $.each(wards, (index, item) => {
                    const str = `<option value="${item.ward_id}">${item.ward_name}</option>`;
                    elem.append(str);
                });
            })
    }

    page.commands.getCustomerById = (id) => {
        return $.ajax({
            type: 'GET',
            url: page.url.getCustomerById + '/' + id,
        });
    }

    page.commands.create = () => {
        const provinceId = page.elements.provinceCre.val();
        const provinceName = page.elements.provinceCre.find('option:selected').text();
        const districtId = page.elements.districtCre.val();
        const districtName = page.elements.districtCre.find('option:selected').text();
        const wardId = page.elements.wardCre.val();
        const wardName = page.elements.wardCre.find('option:selected').text();
        const address = page.elements.addressCre.val();

        let locationRegion = {
            provinceId,
            provinceName,
            districtId,
            districtName,
            wardId,
            wardName,
            address
        }

        const fullName = page.elements.fullNameCre.val();
        const email = page.elements.emailCre.val();
        const phone = page.elements.phoneCre.val();
        const nameGender = page.elements.genderCre.find('option:selected').val();

        let dayCre = page.elements.dayCre.val();
        let monthCre = page.elements.monthCre.val();
        let yearCre = page.elements.yearCre.val();

        const birthDay = dayCre + '/' + monthCre + '/' + yearCre;

        const identityNumber = page.elements.identityCre.val();
        const ethnic = page.elements.ethnicCre.find('option:selected').text();
        const job = page.elements.jobCre.find('option:selected').text();


        let customer = {
            fullName,
            email,
            nameGender,
            phone,
            birthDay,
            job,
            identityNumber,
            ethnic,
            locationRegion,
            userId
        }

        $.ajax({
            headers: {
                'accept': 'application/json',
                'content-type': 'application/json'
            },
            type: 'POST',
            url: page.url.createCustomer,
            data: JSON.stringify(customer)
        })
            .done((data) => {
                App.showSuccessAlert("Tạo hồ sơ thành công!")
            })
            .fail((error) => {
                const responseJSON = error.responseJSON;

                // page.elements.errorAreaCreate.empty();
                let str = '';

                $.each(responseJSON, (k, v) => {
                    str += `<label for="${k}Dep">${v}</label>`
                })

                // page.elements.errorAreaCreate.append(str).removeClass('hide').addClass('show');
            })
    }

    page.initializeControlEvent = () => {
        page.elements.provinceCre.on('change', function () {
            const provinceId = $(this).val();
            page.commands.getAllDistricts(provinceId, page.elements.districtCre).then(() => {
                const districtId = page.elements.districtCre.val();
                page.commands.getAllWards(districtId, page.elements.wardCre);
            });
        })

        page.elements.districtCre.on('change', function () {
            const districtId = page.elements.districtCre.val();
            page.commands.getAllWards(districtId, page.elements.wardCre);
        })

        page.elements.btnCreate.on('click', () => {
        // bắt sự kiện nhấn vô nút save create
        //     page.elements.frmCreate.validate();
            page.elements.frmCreate.trigger("submit");
        })

        page.elements.btnClear.on('click', () => {
            page.elements.frmCreate[0].reset();
            // page.dialogs.elements.frmCreate.validate().resetForm();
            // page.dialogs.elements.frmCreate.find("input.error").removeClass("error");
            // page.dialogs.elements.errorAreaCreate.removeClass("show").addClass("hide").empty();
        })
    }
    page.loadData = () => {
        page.commands.getAllYear();
        page.commands.getAllMonth();
        page.commands.getAllDay();
        page.commands.getAllJob();
        page.commands.getAllEthnic();
        page.commands.getAllProvince().then(() => {
            const provinceId = page.elements.provinceCre.val();
            page.commands.getAllDistricts(provinceId, page.elements.districtCre).then(() => {
                const districtId = page.elements.districtCre.val();
                page.commands.getAllWards(districtId, page.elements.wardCre);
            });
        });
    }
    $(() => {
        page.loadData();
        page.initializeControlEvent();
    })
    $.validator.addMethod(
        "regex",
        function(value, element, regexp) {
            return this.optional(element) || regexp.test(value);
        },
        "Giá trị không hợp lệ"
    );

    page.elements.frmCreate.validate({
        onfocusout: function (element) {
            page.elements.frmCreate.valid();
        },
        rules: {
            fullNameCre: {
                required: true,
                minlength: 5,
                maxlength: 25
            },
            emailCre: {
                required: true,
                regex: /^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,})+$/,
            },
            genderCre: {
                required: true,
            },
            dayCre: {
                required: true,
                regex: '^(1|2?[0-9]|3[0-1])$'
            },
            monthCre: {
                required: true,
                regex: '^(0?[1-9]|1[0-2])$'
            },
            yearCre: {
                required: true,
                regex: '^(19|20)\\d{2}$'
            },
            phoneCre: {
                required: true,
                // regex: /^\+\d{1,2} \(\d{3}\) \d{3}-\d{4}$/
            },
            jobCre: {
                required: true
            },
            identityCre: {
                required: true,
                regex: /^\d{9}$/
            },
            addressCre: {
                required: true,
                maxlength: 50
            },
        },
        messages: {
            fullNameCre:{
                required: "Bắt buộc nhập Full Name",
                minlength: 'Full Name tối thiểu ${0} ký tự',
                maxlength: 'Full Name tối đa ${0} ký tự'
            },
            emailCre: {
                required: "Email là bắt buộc",
                regex: 'Email không hợp lệ'
            },

            genderCre: {
                required: 'Vui lòng chọn giới tính',
            },
            dayCre: {
                required: 'Vui lòng chọn ngày',
                regex: 'Ngày không hợp lệ'
            },
            monthCre: {
                required: 'Vui lòng chọn ngày tháng',
                regex: 'Tháng không hợp lệ'
            },
            yearCre: {
                required: 'Vui lòng chọn ngày tháng',
                regex: 'Năm không hợp lệ'
            },
            phoneCre: {
                required: 'Điện thoại là bắt buộc',
                // regex: 'Số điện thoại không hợp lệ'
            },
            jobCre: {
                required: 'Vui lòng chọn công việc'
            },
            identityCre: {
                required: 'Số CMND là bắt buộc',
                regex: 'Số CMND không đúng định dạng'
            },
            addressCre: {
                required: 'Địa chỉ là bắt buộc',
                maxlength: 'Địa chỉ tối đa ${0} ký tự'
            },
        },
        // errorLabelContainer: "#modalCreate .error-area",
        // errorPlacement: function (error) {
        //     error.appendTo("#modalCreate .error-area");
        // },
        errorElement: "div",
        errorClass: "style_alertSpan__2UfTW",

        showErrors: function(errorMap, errorList) {
            // if (this.numberOfInvalids() > 0) {
            //     page.dialogs.elements.errorAreaCreate.removeClass("hide").addClass("show");
            // } else {
            //     page.dialogs.elements.errorAreaCreate.removeClass("show").addClass("hide").empty();
            //     $("#frmCreate input.error").removeClass("error");
            // }
            this.defaultShowErrors();
        },
        submitHandler: function (e) {
            page.commands.create();
            e.preventDefault();
        }
    })
</script>
</body>

</html>